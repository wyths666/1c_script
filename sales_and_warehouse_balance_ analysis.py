import pandas as pd
from datetime import datetime
import os

# === 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ ===
files = ['ostatki.xlsx', 'prodano.xlsx']
for f in files:
    if not os.path.exists(f):
        print(f"–§–∞–π–ª {f} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        exit()

# === 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ ===
try:
    df_ost = pd.read_excel('ostatki.xlsx', engine='openpyxl')
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤: {e}")
    exit()

df_ost = df_ost.dropna(how='all')
df_ost.columns = ['', '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞', '–û—Å—Ç–∞—Ç–æ–∫_–≤_–º–∞–≥–∞–∑–∏–Ω–µ', '–û—Å—Ç–∞—Ç–æ–∫_–Ω–∞_—Å–∫–ª–∞–¥–µ']

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∏—Å–µ–ª
df_ost['–û—Å—Ç–∞—Ç–æ–∫_–≤_–º–∞–≥–∞–∑–∏–Ω–µ'] = pd.to_numeric(df_ost['–û—Å—Ç–∞—Ç–æ–∫_–≤_–º–∞–≥–∞–∑–∏–Ω–µ'], errors='coerce').fillna(0)
df_ost['–û—Å—Ç–∞—Ç–æ–∫_–Ω–∞_—Å–∫–ª–∞–¥–µ'] = pd.to_numeric(df_ost['–û—Å—Ç–∞—Ç–æ–∫_–Ω–∞_—Å–∫–ª–∞–¥–µ'], errors='coerce').fillna(0)

# –û–±—Ä–µ–∑–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞
df_ost['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'] = df_ost['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'].apply(
    lambda x: x[:-4] if isinstance(x, str) and len(x) > 4 else x
)

# === 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥–∞–∂–∏ ===
try:
    df_prod = pd.read_excel('prodano.xlsx', engine='openpyxl')
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂: {e}")
    exit()

df_prod = df_prod.dropna(how='all')
df_prod.columns = ['', '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞', '–ü—Ä–æ–¥–∞–Ω–æ']
df_prod['–ü—Ä–æ–¥–∞–Ω–æ'] = pd.to_numeric(df_prod['–ü—Ä–æ–¥–∞–Ω–æ'], errors='coerce').fillna(0)

# –û–±—Ä–µ–∑–∞–µ–º –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É
df_prod['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'] = df_prod['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'].apply(
    lambda x: x[:-4] if isinstance(x, str) and len(x) > 4 else x
)

# === 4. –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ ===
df = pd.merge(df_ost, df_prod, on='–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞', how='outer')
df['–ü—Ä–æ–¥–∞–Ω–æ'] = df['–ü—Ä–æ–¥–∞–Ω–æ'].fillna(0)
df['–û—Å—Ç–∞—Ç–æ–∫_–≤_–º–∞–≥–∞–∑–∏–Ω–µ'] = df['–û—Å—Ç–∞—Ç–æ–∫_–≤_–º–∞–≥–∞–∑–∏–Ω–µ'].fillna(0)
df['–û—Å—Ç–∞—Ç–æ–∫_–Ω–∞_—Å–∫–ª–∞–¥–µ'] = df['–û—Å—Ç–∞—Ç–æ–∫_–Ω–∞_—Å–∫–ª–∞–¥–µ'].fillna(0)

# === üîπ –ü–û–¢–û–ö 1: –¢–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –Ω–æ –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ ===
# –î–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–¥–∞–∂ –Ω–µ—Ç
df1 = df[
    (df['–û—Å—Ç–∞—Ç–æ–∫_–≤_–º–∞–≥–∞–∑–∏–Ω–µ'] == 0) &
    (df['–û—Å—Ç–∞—Ç–æ–∫_–Ω–∞_—Å–∫–ª–∞–¥–µ'] > 0)
].copy()

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è = –≤—Å—ë, —á—Ç–æ –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ
df1['–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É'] = 1

# –û—Å—Ç–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
df1 = df1[[
    '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞',
    '–ü—Ä–æ–¥–∞–Ω–æ',
    '–û—Å—Ç–∞—Ç–æ–∫_–≤_–º–∞–≥–∞–∑–∏–Ω–µ',
    '–û—Å—Ç–∞—Ç–æ–∫_–Ω–∞_—Å–∫–ª–∞–¥–µ',
    '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É'
]]

# === üîπ –ü–û–¢–û–ö 2: –¢–æ–≤–∞—Ä—ã –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º (–≥–¥–µ –Ω—É–∂–Ω–æ –¥–æ–∑–∞–∫–∞–∑–∞—Ç—å) ===
# –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ –ø—Ä–æ–¥–∞–∂–∏
df2 = df[df['–ü—Ä–æ–¥–∞–Ω–æ'] > 0].copy()

# –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
df2['–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É'] = df2['–ü—Ä–æ–¥–∞–Ω–æ'] - df2['–û—Å—Ç–∞—Ç–æ–∫_–≤_–º–∞–≥–∞–∑–∏–Ω–µ']
df2['–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É'] = df2['–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É'].clip(lower=0)  # –Ω–µ –º–µ–Ω—å—à–µ 0

# –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ –æ—Å—Ç–∞—Ç–∫—É –Ω–∞ —Å–∫–ª–∞–¥–µ
df2['–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É'] = df2[['–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É', '–û—Å—Ç–∞—Ç–æ–∫_–Ω–∞_—Å–∫–ª–∞–¥–µ']].min(axis=1)

# –§–∏–ª—å—Ç—Ä—É–µ–º: —Ç–æ–ª—å–∫–æ –≥–¥–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è > 0
df2 = df2[df2['–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É'] > 0].copy()

# –û—Å—Ç–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
df2 = df2[[
    '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞',
    '–ü—Ä–æ–¥–∞–Ω–æ',
    '–û—Å—Ç–∞—Ç–æ–∫_–≤_–º–∞–≥–∞–∑–∏–Ω–µ',
    '–û—Å—Ç–∞—Ç–æ–∫_–Ω–∞_—Å–∫–ª–∞–¥–µ',
    '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É'
]]

# === 5. –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–≤–∞ –ø–æ—Ç–æ–∫–∞ ===
result = pd.concat([df1, df2], ignore_index=True)

# –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ (–µ—Å–ª–∏ —Ç–æ–≤–∞—Ä –ø–æ–ø–∞–ª –≤ –æ–±–∞ —Å–ø–∏—Å–∫–∞ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –æ–¥–∏–Ω)
result = result.drop_duplicates(subset=['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'], keep='first')

# –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Å—Ç–æ–ª–±—Ü—ã
result.columns = [
    '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞',
    '–ü—Ä–æ–¥–∞–∂–∏ –∑–∞ 3 –Ω–µ–¥–µ–ª–∏',
    '–û—Å—Ç–∞—Ç–æ–∫ –≤ –º–∞–≥–∞–∑–∏–Ω–µ',
    '–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ',
    '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É'
]

# –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ —Ç–µ, –≥–¥–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è >0
result = result.sort_values(by='–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–∫–∞–∑—É', ascending=False)

# –°–æ—Ö—Ä–∞–Ω—è–µ–º
current_date = datetime.now().strftime('%d-%m-%Y')
result.to_excel(f'–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –æ—Ç {current_date}.xlsx', index=False)

print(f"–ì–æ—Ç–æ–≤–æ! –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ {len(result)} –ø–æ–∑–∏—Ü–∏–π.")
print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ '–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –æ—Ç {current_date}.xlsx'")